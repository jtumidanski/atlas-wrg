# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  - main

resources:
  - repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'atlasms'
  imageRepository: 'atlas-wrg'
  containerRegistry: 'atlasms.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
  - stage: BuildArtifacts
    displayName: Build and Deploy Artifacts
    jobs:
      - job: Build
        displayName: Build and Deploy Artifacts
        pool:
          vmImage: 'ubuntu-latest'
        steps:
              - task: Go@0
                inputs:
                  command: 'build'
                  workingDirectory: '$(System.DefaultWorkingDirectory)/atlas.com/wrg/'
              - task: Docker@2
                displayName: Build and push an image to container registry
                inputs:
                  command: buildAndPush
                  repository: $(imageRepository)
                  dockerfile: $(dockerfilePath)
                  containerRegistry: $(dockerRegistryServiceConnection)
                  tags: |
                    $(tag)
#  - stage: BuildDocker
#    displayName: Build and Push Docker Image
#    jobs:
#      - job: Build
#        displayName: Build and Push Docker Image
#        pool:
#          vmImage: 'ubuntu-latest'
#        steps:
